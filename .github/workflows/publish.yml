name: Publish to PyPI

on:
  workflow_run:
    workflows: ["Release"]
    types: [completed]

jobs:
  publish:
    name: Publish to PyPI (Trusted Publishing)
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read
      actions: read

    environment:
      name: pypi

    steps:
      - name: Check for dist artifact
        id: hasdist
        uses: actions/github-script@v7
        with:
          script: |
            const run_id = Number(process.env.RUN_ID);
            const { owner, repo } = context.repo;

            const res = await github.rest.actions.listWorkflowRunArtifacts({
              owner,
              repo,
              run_id
            });

            const has = res.data.artifacts.some(a => a.name === "dist");
            core.setOutput("present", has ? "true" : "false");

            if (has) {
              core.info("Found dist artifact; will publish to PyPI.");
            } else {
              core.info("No dist artifact found; skipping PyPI publish.");
            }
        env:
          RUN_ID: ${{ github.event.workflow_run.id }}

      - name: Download dist artifacts from Release run
        if: steps.hasdist.outputs.present == 'true'
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to PyPI
        if: steps.hasdist.outputs.present == 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        # Optional safety net:
        # with:
        #   skip-existing: true

      - name: No artifacts to publish
        if: steps.hasdist.outputs.present != 'true'
        run: echo "No dist artifacts found for this Release run; skipping PyPI publish."
