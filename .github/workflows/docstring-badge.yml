name: Docstring Coverage Badge

on:
  push:
    branches: [main]
    paths:
      - "windseeker/**"
      - "pyproject.toml"
      - "tests/**"
      - ".github/workflows/**"

permissions:
  contents: write

jobs:
  badge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dev dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Compute docstring coverage
        id: cov
        run: |
          set -e

          OUTPUT="$(interrogate -q windseeker || true)"
          echo "$OUTPUT"

          PCT=$(echo "$OUTPUT" | python -c "
import sys, re
text = sys.stdin.read()
m = re.search(r'(\\d+(?:\\.\\d+)?)%', text)
print(m.group(1) if m else '0')
")

          echo "pct=$PCT" >> "$GITHUB_OUTPUT"

      - name: Build badge JSON
        run: |
          python - <<'PY'
import json, os

pct = float(os.environ["PCT"])

def color(p):
    if p >= 90: return "brightgreen"
    if p >= 80: return "green"
    if p >= 70: return "yellowgreen"
    if p >= 60: return "yellow"
    if p >= 50: return "orange"
    return "red"

data = {
    "schemaVersion": 1,
    "label": "docstrings",
    "message": f"{pct:.1f}%",
    "color": color(pct),
}

with open("docstring-coverage.json", "w", encoding="utf-8") as f:
    json.dump(data, f)
PY
        env:
          PCT: ${{ steps.cov.outputs.pct }}

      - name: Publish badge to gh-pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout --orphan gh-pages
          git rm -rf .

          mv docstring-coverage.json docstring-coverage.json
          git add docstring-coverage.json
          git commit -m "Update docstring coverage badge"
          git push -f origin gh-pages
