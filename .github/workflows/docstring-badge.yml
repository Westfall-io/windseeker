name: docstring-badge

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  badge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Compute docstring coverage (interrogate)
        id: coverage
        shell: bash
        run: |
          set -euo pipefail

          # Capture stdout+stderr, and don't fail the workflow just because interrogate returns nonzero
          OUTPUT="$(interrogate -v windseeker 2>&1 || true)"
          echo "$OUTPUT"

          # Parse the "Overall coverage" percentage (most stable across interrogate versions)
          PCT="$(echo "$OUTPUT" | python -c "import sys,re; t=sys.stdin.read(); m=re.search(r'(?i)Overall coverage[^0-9]*([0-9]+(?:\.[0-9]+)?)%', t); print(m.group(1) if m else '0')")"

          echo "pct=$PCT" >> "$GITHUB_OUTPUT"
          echo "Parsed pct=$PCT"

      - name: Build Shields.io endpoint JSON
        shell: bash
        env:
          PCT: ${{ steps.coverage.outputs.pct }}
        run: |
          set -euo pipefail
          mkdir -p badge

          python - <<'PY'
          import json, os
          pct = float(os.environ.get("PCT", "0") or "0")

          def color(p):
              return (
                  "brightgreen" if p >= 90 else
                  "green"       if p >= 80 else
                  "yellowgreen" if p >= 70 else
                  "yellow"      if p >= 60 else
                  "orange"      if p >= 50 else
                  "red"
              )

          data = {
              "schemaVersion": 1,
              "label": "docstrings",
              "message": f"{pct:.1f}%",
              "color": color(pct),
          }

          with open("badge/docstring-coverage.json", "w", encoding="utf-8") as f:
              json.dump(data, f)
          PY

          # Ensure a dotfile exists so peaceiris doesn't log cp errors for badge/.*
          touch badge/.nojekyll
          touch badge/.keep

      - name: Publish badge to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: badge
          destination_dir: .
          keep_files: true
          enable_jekyll: false
